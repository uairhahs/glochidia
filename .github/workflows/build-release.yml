name: Build and Release Static Binaries
# trunk-ignore-all(yamllint/quoted-strings)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (e.g., latest, v1.0.0)"
        required: true
        default: "latest"
  push:
    branches:
      - master
    tags:
      - "v*"

env:
  REPO_VERSION: "1.0.0"
  CARGO_TERM_COLOR: always

jobs:
  build-rust:
    name: Build Rust Tools
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tool:
          - name: gpm
            description: "Glochidia Package Manager"
            license: "GPL-2.0-or-later"
            source_url: "https://github.com/${{ github.repository }}"
            working_dir: gpm
            version: ""
            git_ref: ""
            repo_url: ""
            binary_name: ""
            build_cmd: ""
          - name: starship
            description: "Cross-shell prompt"
            license: "ISC"
            source_url: "https://github.com/starship/starship"
            repo_url: "https://github.com/starship/starship"
            build_cmd: "cargo build --release --no-default-features --features battery"
            version: ""
            git_ref: ""
            working_dir: ""
            binary_name: ""
          - name: msedit
            description: "Text editor for terminals"
            license: "MIT"
            source_url: "https://github.com/microsoft/edit"
            repo_url: "https://github.com/microsoft/edit"
            binary_name: "edit"
            build_cmd: "cargo build --all-features --release"
            version: ""
            git_ref: ""
            working_dir: ""
            target: "x86_64-unknown-linux-gnu"
          - name: set_locale
            description: "Locale management utilities (set_locale, locale-gen)"
            license: "GPL-2.0-or-later"
            source_url: "https://github.com/${{ github.repository }}"
            working_dir: glochidia-locale
            binary_name: "set_locale"
            version: ""
            git_ref: ""
            repo_url: ""
            build_cmd: ""

    container:
      image: rust:alpine
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install GNU tar for caching
        run: apk add --no-cache tar bash

      - name: Fetch latest release version
        id: fetch-version
        run: |
          if [ -n "${{ matrix.tool.working_dir }}" ]; then
            echo "version=${{ env.REPO_VERSION }}" >> $GITHUB_OUTPUT
          else
            VERSION=$(sh scripts/fetch-version.sh \
              "${{ matrix.tool.name }}" \
              "${{ matrix.tool.source_url }}" \
              "${{ matrix.tool.repo_url }}" \
              "${{ matrix.tool.version }}" \
              "${{ matrix.tool.git_ref }}")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Cache compiled binary
        id: cache-binary
        uses: actions/cache@v4
        with:
          path: ${{ matrix.tool.name }}-bin
          key: ${{ runner.os }}-binary-${{ matrix.tool.name }}-${{ steps.fetch-version.outputs.version }}-musl

      - name: Install build dependencies
        run: apk add --no-cache git musl-dev file cmake make gcc g++ linux-headers

      - name: Cache cargo registry
        if: steps.cache-binary.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        if: steps.cache-binary.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Build ${{ matrix.tool.name }}
        if: steps.cache-binary.outputs.cache-hit != 'true'
        run: |
          sh scripts/build-rust-tool.sh \
            "${{ matrix.tool.name }}" \
            "${{ matrix.tool.source_url }}" \
            "${{ matrix.tool.working_dir }}" \
            "${{ matrix.tool.build_cmd }}" \
            "${{ matrix.tool.binary_name }}" \
            "${{ steps.fetch-version.outputs.version }}" \
            "${{ env.REPO_VERSION }}" \
            "${{ matrix.tool.target || 'x86_64-unknown-linux-musl' }}"

      - name: Verify static binary
        if: steps.cache-binary.outputs.cache-hit != 'true'
        run: sh scripts/verify-binary.sh "${{ matrix.tool.name }}-bin" "${{ matrix.tool.name }}"

      - name: Finalize version metadata
        run: |
          sh scripts/finalize-version.sh \
            "${{ matrix.tool.name }}" \
            "${{ matrix.tool.version }}" \
            "${{ steps.fetch-version.outputs.version }}" \
            "${{ env.REPO_VERSION }}" \
            "${{ matrix.tool.working_dir }}"

      - name: Upload artifact with metadata
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.tool.name }}
          path: |
            ${{ matrix.tool.name }}-bin
            ${{ matrix.tool.name }}.version

  build-c-tools:
    name: Build C/C++ Tools
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tool:
          - name: make
            description: "GNU Make build tool"
            license: "GPL-3.0-or-later"
            source_url: "https://ftp.gnu.org/gnu/make/make-4.4.1.tar.gz"
            source_sha256: "dd16fb1d67bfab79a72f5e8390735c49e3e8e70b4945a15ab1f81ddb78658fb3"
            build_cmd: "./configure LDFLAGS=-static && make -j$(nproc)"
            version: ""
            git_ref: ""
          - name: gawk
            description: "GNU Awk text processing"
            license: "GPL-3.0-or-later"
            source_url: "https://ftp.gnu.org/gnu/gawk/gawk-5.3.2.tar.xz"
            source_sha256: "3203e52edb182061ac4fe37f0040e8d5b5ed5d37e1c8a1dcf5d8288d0c757cd5"
            build_cmd: "./configure LDFLAGS=-static && make -j$(nproc)"
            version: ""
            git_ref: ""
          - name: ble.sh
            description: "Bash Line Editor"
            license: "BSD-3-Clause"
            source_url: "https://github.com/akinomyoga/ble.sh"
            build_cmd: "make"
            version: "0.4.0"
            git_ref: ""
            source_sha256: ""
          - name: fastfetch
            description: "System information tool"
            license: "MIT"
            source_url: "https://github.com/fastfetch-cli/fastfetch"
            build_cmd: "cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXE_LINKER_FLAGS=-static -DENABLE_SYSTEM_YYJSON=OFF -DENABLE_DIRECTWRITE=OFF -DENABLE_XRANDR=OFF -DENABLE_X11=OFF -DENABLE_WAYLAND=OFF -DENABLE_GIO=OFF -DENABLE_DCONF=OFF -DENABLE_DBUS=OFF -DENABLE_XFCONF=OFF -DENABLE_SQLITE3=OFF -DENABLE_IMAGEMAGICK=OFF -DENABLE_CHAFA=OFF -DENABLE_ZLIB=OFF -DENABLE_EGL=OFF -DENABLE_GLX=OFF -DENABLE_OSMESA=OFF -DENABLE_OPENCL=OFF -DENABLE_VULKAN=OFF -DENABLE_RPM=OFF -DENABLE_DRM=OFF -DENABLE_FREETYPE=OFF && cmake --build build --target fastfetch"
            version: ""
            git_ref: ""
            source_sha256: ""
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch latest release version
        id: fetch-version
        run: |
          VERSION=$(bash scripts/fetch-version.sh \
            "${{ matrix.tool.name }}" \
            "${{ matrix.tool.source_url }}" \
            "" \
            "${{ matrix.tool.version }}" \
            "${{ matrix.tool.git_ref }}")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Build ${{ matrix.tool.name }}
        run: |
          bash scripts/build-c-tool.sh \
            "${{ matrix.tool.name }}" \
            "${{ matrix.tool.source_url }}" \
            "${{ matrix.tool.build_cmd }}" \
            "${{ matrix.tool.version }}" \
            "${{ steps.fetch-version.outputs.version }}"

      - name: Verify static binary
        run: bash scripts/verify-binary.sh "${{ matrix.tool.name }}-bin" "${{ matrix.tool.name }}"

      - name: Finalize version metadata
        run: |
          bash scripts/finalize-version.sh \
            "${{ matrix.tool.name }}" \
            "${{ matrix.tool.version }}" \
            "${{ steps.fetch-version.outputs.version }}" \
            "${{ env.REPO_VERSION }}" \
            ""

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.tool.name }}
          path: |
            ${{ matrix.tool.name }}-bin
            ${{ matrix.tool.name }}.version

  generate-manifest:
    name: Generate Manifest and Create Release
    needs: [build-rust, build-c-tools]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare binaries
        run: |
          mkdir -p release-files versions
          echo "Preparing binaries..."
          for dir in artifacts/*/; do
            tool=$(basename "$dir")
            if [ -f "$dir/${tool}-bin" ]; then
              mv "$dir/${tool}-bin" "release-files/${tool}"
              echo "  - $tool"
            fi
            if [ -f "$dir/${tool}.version" ]; then
              mv "$dir/${tool}.version" "versions/${tool}.version"
            fi
            # Handle glochidia-locale's additional binaries
            if [ -f "$dir/set_locale-bin" ]; then
              mv "$dir/set_locale-bin" "release-files/set_locale"
              echo "  - set_locale"
            fi
            if [ -f "$dir/set_locale.version" ]; then
              mv "$dir/set_locale.version" "versions/set_locale.version"
            fi
          done
          chmod +x release-files/*
          ls -lh release-files/
          echo "Versions collected:"
          ls -lh versions/ || true

      - name: Download GPL licenses
        run: |
          mkdir -p licenses
          if [ ! -f licenses/GPL-2.0.txt ]; then
            echo "Downloading GPL-2.0..."
            curl -sS https://www.gnu.org/licenses/old-licenses/gpl-2.0.txt -o licenses/GPL-2.0.txt
          fi
          if [ ! -f licenses/GPL-3.0.txt ]; then
            echo "Downloading GPL-3.0..."
            curl -sS https://www.gnu.org/licenses/gpl-3.0.txt -o licenses/GPL-3.0.txt
          fi

      - name: Build ZimaOS RAW package
        run: |
          sudo apt-get update && sudo apt-get install -y squashfs-tools
          bash zpkg/build-zpkg.sh
          cp gpm.raw release-files/
          echo "Added gpm.raw to release files"

      - name: Copy compliance files
        run: |
          cp SOURCES.txt release-files/
          cp COPYING release-files/
          cp -r licenses release-files/

      - name: Generate manifest with Python
        run: |
          python3 scripts/generate-manifest.py \
            "${{ github.repository }}" \
            "${{ github.event.inputs.release_tag || 'latest' }}" \
            "${{ env.REPO_VERSION }}"
          echo ""
          echo "Final release files:"
          ls -lh release-files/
          echo ""
          echo "Manifest SHA256 checksums:"
          grep '"sha256"' release-files/manifest.json

      - name: Generate release body
        run: |
          REPO="${{ github.repository }}"
          RELEASE_TAG="${{ github.event.inputs.release_tag || 'latest' }}"
          BUILD_INFO="${{ github.event_name == 'workflow_dispatch' && 'manually' || 'from tag push' }}"
          COMMIT="${{ github.sha }}"
          python3 scripts/generate-release-body.py "$REPO" "$RELEASE_TAG" "$BUILD_INFO" "$COMMIT"
          cat release-body.md

      - name: Determine release version
        id: release-version
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            # Use explicitly provided tag from workflow dispatch
            VERSION="${{ github.event.inputs.release_tag }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Use tag from push event (e.g., v1.0.0)
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            # Push to master branch always uses "latest"
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-version.outputs.version }}
          name: Release ${{ steps.release-version.outputs.version }}
          body_path: release-body.md
          files: |
            release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
