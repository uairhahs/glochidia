name: Build and Release Static Binaries
# trunk-ignore-all(yamllint/quoted-strings)

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (e.g., latest, v1.0.0)"
        required: true
        default: "latest"
  push:
    tags:
      - "v*"

env:
  REPO_VERSION: "1.0.0"
  CARGO_TERM_COLOR: always

jobs:
  build-rust:
    name: Build Rust Tools
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tool:
          - name: gpm
            version: "0.1.0"
            description: "Glochidia Package Manager"
            license: "GPL-2.0-or-later"
            source_url: "https://github.com/${{ github.repository }}"
            working_dir: gpm
          - name: starship
            version: "1.24.1"
            description: "Cross-shell prompt"
            license: "ISC"
            source_url: "https://github.com/starship/starship"
            repo_url: "https://github.com/starship/starship"
            build_cmd: "cargo build --release --target x86_64-unknown-linux-musl --no-default-features --features battery"
          - name: fastfetch
            version: "2.30.2"
            description: "System information tool"
            license: "MIT"
            source_url: "https://github.com/fastfetch-cli/fastfetch"
            repo_url: "https://github.com/fastfetch-cli/fastfetch"
            build_cmd: "cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_SYSTEM_YYJSON=OFF -DENABLE_DIRECTWRITE=OFF -DENABLE_XRANDR=OFF -DENABLE_X11=OFF -DENABLE_WAYLAND=OFF -DENABLE_GIO=OFF -DENABLE_DCONF=OFF -DENABLE_DBUS=OFF -DENABLE_XFCONF=OFF -DENABLE_SQLITE3=OFF -DENABLE_IMAGEMAGICK=OFF -DENABLE_CHAFA=OFF -DENABLE_ZLIB=OFF -DENABLE_EGL=OFF -DENABLE_GLX=OFF -DENABLE_OSMESA=OFF -DENABLE_OPENCL=OFF -DENABLE_VULKAN=OFF -DENABLE_RPM=OFF -DENABLE_DRM=OFF -DENABLE_FREETYPE=OFF && cmake --build build --target fastfetch"
    container:
      image: rust:alpine
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install GNU tar for caching
        run: apk add --no-cache tar

      - name: Cache compiled binary
        id: cache-binary
        uses: actions/cache@v4
        with:
          path: ${{ matrix.tool.name }}-bin
          key: ${{ runner.os }}-binary-${{ matrix.tool.name }}-${{ matrix.tool.version }}-musl

      - name: Install build dependencies
        if: steps.cache-binary.outputs.cache-hit != 'true'
        run: apk add --no-cache musl-dev file git cmake make gcc g++ linux-headers

      - name: Prepare cache directories
        if: steps.cache-binary.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.cargo/registry ~/.cargo/git
          mkdir -p ${{ matrix.tool.working_dir }}/target

      - name: Cache cargo registry
        if: steps.cache-binary.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        if: steps.cache-binary.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        if: steps.cache-binary.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ${{ matrix.tool.working_dir }}/target
            /tmp/build_${{ matrix.tool.name }}/target
          key: ${{ runner.os }}-cargo-build-${{ matrix.tool.name }}-${{ matrix.tool.version }}-musl

      - name: Build ${{ matrix.tool.name }}
        run: |
          echo "Building ${{ matrix.tool.name }}..."
          WORKSPACE_DIR="$(pwd)"
          if [ -n "${{ matrix.tool.working_dir }}" ]; then
            cd ${{ matrix.tool.working_dir }}
            cargo build --release --target x86_64-unknown-linux-musl
            strip target/x86_64-unknown-linux-musl/release/${{ matrix.tool.name }}
            cp target/x86_64-unknown-linux-musl/release/${{ matrix.tool.name }} ../${{ matrix.tool.name }}-bin
          elif [ -n "${{ matrix.tool.repo_url }}" ]; then
            # Build external repos
            BUILD_DIR="/tmp/build_${{ matrix.tool.name }}"
            git clone ${{ matrix.tool.repo_url }} ${BUILD_DIR}
            cd ${BUILD_DIR}
            eval "${{ matrix.tool.build_cmd }}"
            # Find and copy binary back to workspace
            if [ -f "target/x86_64-unknown-linux-musl/release/${{ matrix.tool.name }}" ]; then
              strip target/x86_64-unknown-linux-musl/release/${{ matrix.tool.name }}
              cp target/x86_64-unknown-linux-musl/release/${{ matrix.tool.name }} "${WORKSPACE_DIR}/${{ matrix.tool.name }}-bin"
            elif [ -f "build/${{ matrix.tool.name }}" ]; then
              strip build/${{ matrix.tool.name }}
              cp build/${{ matrix.tool.name }} "${WORKSPACE_DIR}/${{ matrix.tool.name }}-bin"
            fi
          fi

      - name: Verify static binary
        if: steps.cache-binary.outputs.cache-hit != 'true'
        run: |
          echo "Verifying ${{ matrix.tool.name }} is statically linked..."
          file ${{ matrix.tool.name }}-bin
          if file ${{ matrix.tool.name }}-bin | grep -q "dynamically linked"; then
            if file ${{ matrix.tool.name }}-bin | grep -q "interpreter"; then
              echo "Error: Binary is dynamically linked with interpreter"
              exit 1
            fi
          fi
          echo "Binary verification passed"

      - name: Test binary
        run: |
          echo "Testing ${{ matrix.tool.name }}..."
          ./${{ matrix.tool.name }}-bin --version || ./${{ matrix.tool.name }}-bin --help || echo "No version/help available"

      - name: Upload artifact with metadata
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.tool.name }}
          path: ${{ matrix.tool.name }}-bin

  build-c-tools:
    name: Build C/C++ Tools
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tool:
          - name: make
            version: "4.4.1"
            description: "GNU Make build tool"
            license: "GPL-3.0-or-later"
            source_url: "https://ftp.gnu.org/gnu/make/make-4.4.1.tar.gz"
            source_sha256: "dd16fb1d67bfab79a72f5e8390735c49e3e8e70b4945a15ab1f81ddb78658fb3"
            build_cmd: "./configure LDFLAGS=-static && make -j$(nproc)"
          - name: gawk
            version: "5.3.2"
            description: "GNU Awk text processing"
            license: "GPL-3.0-or-later"
            source_url: "https://ftp.gnu.org/gnu/gawk/gawk-5.3.2.tar.xz"
            source_sha256: "3203e52edb182061ac4fe37f0040e8d5b5ed5d37e1c8a1dcf5d8288d0c757cd5"
            build_cmd: "./configure LDFLAGS=-static && make -j$(nproc)"
          - name: ble.sh
            version: "0.4.0"
            description: "Bash Line Editor"
            license: "BSD-3-Clause"
            source_url: "https://github.com/akinomyoga/ble.sh"
            build_cmd: "make"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache compiled binary
        id: cache-binary
        uses: actions/cache@v4
        with:
          path: ${{ matrix.tool.name }}-bin
          key: ${{ runner.os }}-binary-${{ matrix.tool.name }}-${{ matrix.tool.version }}-musl-static

      - name: Install podman
        if: steps.cache-binary.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Build ${{ matrix.tool.name }}
        if: steps.cache-binary.outputs.cache-hit != 'true'
        run: |
          # Set up environment for grow_glochidium.sh
          export CONTAINER_RUNTIME=podman
          export DEPLOY_METHOD=ci-cd
          export DEPLOY_USER=ci
          export DEPLOY_HOST=localhost
          export DEPLOY_PATH=/tmp/ci

          # Run the build script and capture output to extract BUILD_DIR
          OUTPUT=$(bash grow_glochidium.sh \
            "${{ matrix.tool.source_url }}" \
            "${{ matrix.tool.name }}" \
            "${{ matrix.tool.build_cmd }}" 2>&1)

          echo "$OUTPUT"

          # Extract the actual BUILD_DIR from the script output
          BUILD_DIR=$(echo "$OUTPUT" | grep "Build directory preserved:" | sed 's/.*Build directory preserved: //')

          if [ -z "$BUILD_DIR" ]; then
            echo "Error: Could not determine BUILD_DIR from script output"
            exit 1
          fi

          echo "Detected BUILD_DIR: $BUILD_DIR"

          # Copy binary from build dir
          if [ -f "${BUILD_DIR}/${{ matrix.tool.name }}" ]; then
            cp "${BUILD_DIR}/${{ matrix.tool.name }}" ./${{ matrix.tool.name }}-bin
          elif [ -f "${BUILD_DIR}/${{ matrix.tool.name }}.sh" ]; then
            cp "${BUILD_DIR}/${{ matrix.tool.name }}.sh" ./${{ matrix.tool.name }}-bin
          else
            echo "Error: Binary not found in ${BUILD_DIR}"
            ls -la "${BUILD_DIR}" || true
            exit 1
          fi

      - name: Verify static binary
        if: steps.cache-binary.outputs.cache-hit != 'true'
        run: |
          echo "Verifying ${{ matrix.tool.name }} is statically linked..."
          file ${{ matrix.tool.name }}-bin
          if file ${{ matrix.tool.name }}-bin | grep -q "dynamically linked"; then
            echo "Error: Binary is dynamically linked"
            exit 1
          fi
          if ! file ${{ matrix.tool.name }}-bin | grep -q "statically linked"; then
            echo "Warning: Cannot confirm static linking"
          fi
          echo "Binary verification passed"

      - name: Test binary
        run: |
          echo "Testing ${{ matrix.tool.name }}..."
          ./${{ matrix.tool.name }}-bin --version

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.tool.name }}
          path: ${{ matrix.tool.name }}-bin

  generate-manifest:
    name: Generate Manifest and Create Release
    needs: [build-rust, build-c-tools]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare binaries
        run: |
          mkdir -p release-files
          echo "Preparing binaries..."
          for dir in artifacts/*/; do
            tool=$(basename "$dir")
            if [ -f "$dir/${tool}-bin" ]; then
              mv "$dir/${tool}-bin" "release-files/${tool}"
              echo "  - $tool"
            fi
          done
          chmod +x release-files/*
          ls -lh release-files/

      - name: Download GPL licenses
        run: |
          mkdir -p licenses
          if [ ! -f licenses/GPL-2.0.txt ]; then
            echo "Downloading GPL-2.0..."
            curl -sS https://www.gnu.org/licenses/old-licenses/gpl-2.0.txt -o licenses/GPL-2.0.txt
          fi
          if [ ! -f licenses/GPL-3.0.txt ]; then
            echo "Downloading GPL-3.0..."
            curl -sS https://www.gnu.org/licenses/gpl-3.0.txt -o licenses/GPL-3.0.txt
          fi

      - name: Generate manifest with Python
        run: |
          python3 << 'PYEOF'
          import json
          import hashlib
          import os
          from datetime import datetime

          RELEASE_TAG = "${{ github.event.inputs.release_tag || github.ref_name }}"
          REPO = "${{ github.repository }}"

          tools_metadata = {
              "gpm": {
                  "version": "0.1.0",
                  "description": "Glochidia Package Manager",
                  "license": "GPL-2.0-or-later",
                  "source_url": f"https://github.com/{REPO}",
                  "build_type": "rust-alpine"
              },
              "make": {
                  "version": "4.4.1",
                  "description": "GNU Make build tool",
                  "license": "GPL-3.0-or-later",
                  "source_url": "https://ftp.gnu.org/gnu/make/make-4.4.1.tar.gz",
                  "source_sha256": "dd16fb1d67bfab79a72f5e8390735c49e3e8e70b4945a15ab1f81ddb78658fb3",
                  "build_type": "alpine"
              },
              "gawk": {
                  "version": "5.3.2",
                  "description": "GNU Awk text processing",
                  "license": "GPL-3.0-or-later",
                  "source_url": "https://ftp.gnu.org/gnu/gawk/gawk-5.3.2.tar.xz",
                  "source_sha256": "3203e52edb182061ac4fe37f0040e8d5b5ed5d37e1c8a1dcf5d8288d0c757cd5",
                  "build_type": "alpine"
              },
              "starship": {
                  "version": "1.24.1",
                  "description": "Cross-shell prompt",
                  "license": "ISC",
                  "source_url": "https://github.com/starship/starship",
                  "build_type": "rust-alpine"
              },
              "fastfetch": {
                  "version": "2.30.2",
                  "description": "System information tool",
                  "license": "MIT",
                  "source_url": "https://github.com/fastfetch-cli/fastfetch",
                  "build_type": "alpine"
              },
              "ble.sh": {
                  "version": "0.4.0",
                  "description": "Bash Line Editor",
                  "license": "BSD-3-Clause",
                  "source_url": "https://github.com/akinomyoga/ble.sh",
                  "build_type": "script"
              }
          }

          manifest = {
              "repo_version": "${{ env.REPO_VERSION }}",
              "updated_at": datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ"),
              "tools": {}
          }

          for tool_name in os.listdir("release-files"):
              if tool_name.startswith("."):
                  continue
              
              filepath = f"release-files/{tool_name}"
              if not os.path.isfile(filepath):
                  continue
              
              with open(filepath, "rb") as f:
                  data = f.read()
                  sha256 = hashlib.sha256(data).hexdigest()
                  size = len(data)
              
              if tool_name not in tools_metadata:
                  print(f"Warning: No metadata for {tool_name}")
                  continue
              
              metadata = tools_metadata[tool_name]
              tool_entry = {
                  "version": metadata["version"],
                  "description": metadata["description"],
                  "url": f"https://github.com/{REPO}/releases/download/{RELEASE_TAG}/{tool_name}",
                  "sha256": sha256,
                  "size": size,
                  "build_type": metadata["build_type"],
                  "license": metadata["license"],
                  "source_url": metadata["source_url"]
              }
              
              if "source_sha256" in metadata:
                  tool_entry["source_sha256"] = metadata["source_sha256"]
              
              manifest["tools"][tool_name] = tool_entry
              print(f"Added {tool_name}: {size} bytes, SHA256: {sha256[:16]}...")

          with open("release-files/manifest.json", "w") as f:
              json.dump(manifest, f, indent=2)

          print("\nGenerated manifest:")
          print(json.dumps(manifest, indent=2))
          PYEOF

      - name: Copy compliance files
        run: |
          cp SOURCES.txt release-files/
          cp COPYING release-files/
          cp -r licenses release-files/
          echo "Release files:"
          ls -lh release-files/

      - name: Create/Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_tag || github.ref_name }}
          name: Release ${{ github.event.inputs.release_tag || github.ref_name }}
          body: |
            ## Static Binaries for ZimaOS

            Built from source with GPL compliance. All binaries are statically linked and verified.

            ### Available Tools
            - **gpm** v0.1.0 - Glochidia Package Manager (install other tools)
            - **make** v4.4.1 - GNU Make build tool
            - **gawk** v5.3.2 - GNU Awk text processing
            - **starship** v1.24.1 - Cross-shell prompt
            - **fastfetch** v2.30.2 - System information tool
            - **ble.sh** v0.4.0 - Bash Line Editor

            ### Installation
            ```bash
            # Download and install gpm
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.release_tag || github.ref_name }}/gpm
            chmod +x gpm
            mv gpm /DATA/bin/

            # Configure PATH and install tools
            gpm setup-path
            source ~/.bashrc
            gpm install make
            gpm install gawk
            gpm list
            ```

            ### Verification
            - `manifest.json` - SHA256 checksums for all binaries
            - `SOURCES.txt` - Source code provenance
            - `COPYING` - GPL compliance notice
            - `licenses/` - Full license texts

            ### Build Information
            - Built: ${{ github.event_name == 'workflow_dispatch' && 'manually' || 'from tag push' }}
            - Commit: ${{ github.sha }}
            - All binaries verified as statically linked
          files: |
            release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
